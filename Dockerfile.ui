FROM node:14.19.1-alpine as build-base

WORKDIR /app

# Install dependencies
COPY package.json package-lock.json ./
RUN npm i

COPY .eslintignore \
  .eslintrc.json \
  babel.config.json \
  jest.config.ts \
  jest.preset.ts \
  modulefederation.config.base.js \
  nx.json \
  webpack.config.base.js \
  tsconfig.base.json \
  workspace.json \
  ./
COPY .storybook ./.storybook
COPY apps ./apps
COPY libs ./libs

###############################################################

FROM build-base as acx-ui
RUN npx nx run-many --target=lint --all --verbose
RUN npx nx run-many --target=test --all --coverage --runInBand

###############################################################

FROM acx-ui as build
RUN npx nx run-many --target=build --all

###############################################################

FROM nginx:1.21.6-alpine

WORKDIR /usr/share/nginx/html

# Remove default nginx static assets
RUN rm -rf ./*

COPY tools/docker/nginx/conf.d/* /etc/nginx/conf.d/
COPY tools/docker/nginx/nginx.conf /etc/nginx/nginx.conf
COPY --from=build /app/dist/apps ./
RUN mv ./rc-wifi main/.

EXPOSE 3000

ENTRYPOINT ["nginx", "-g", "daemon off;"]
