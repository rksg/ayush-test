ARG CI_SERVICE_BASE
FROM ${CI_SERVICE_BASE}node:16.15.0-alpine as build-base

WORKDIR /app

RUN apk add curl

ARG ENV_FILE
COPY ${ENV_FILE} .
RUN export $(cat ${ENV_FILE}) \
  && npm config set registry "http://artifactory.cicd.rks-cloud.com/artifactory/api/npm/npm/" \
  && curl -u "${ARTI_USER}:${ARTI_PASSWORD}" "http://artifactory.cicd.rks-cloud.com/artifactory/api/npm/auth" >> ~/.npmrc

# Install dependencies
COPY package.json package-lock.json ./
RUN npm install

COPY .eslintignore \
  .eslintrc.json \
  babel.config.json \
  jest.config.ts \
  jest.preset.ts \
  jest.setup.js \
  modulefederation.config.base.js \
  nx.json \
  webpack.config.base.js \
  tsconfig.base.json \
  workspace.json \
  ./
COPY .storybook ./.storybook
COPY apps ./apps
COPY libs ./libs
COPY tools/tests ./tools/tests

# dump git information
RUN export $(cat ${ENV_FILE}) \
  && echo NX_GIT_SHA=$DRONE_COMMIT_SHA >> .env \
  && echo NX_GIT_DATE=\'$(date -R "@$((DRONE_BUILD_CREATED))")\' >> .env

###############################################################
# FROM build-base as acx-ui
# ENV NODE_OPTIONS=--max-old-space-size=8192
# RUN node ./node_modules/.bin/nx run-many --target=lint --all --verbose
# COPY tools/docker/tscValidator.sh ./tools/docker/tscValidator.sh
# RUN chmod +x tools/docker/tscValidator.sh
# RUN tools/docker/tscValidator.sh
# RUN node ./node_modules/.bin/nx run rc:test --coverage --maxWorkers=50%
# RUN node ./node_modules/.bin/nx run analytics:test --coverage --maxWorkers=50%
# RUN node ./node_modules/.bin/nx run-many --target=test --all --exclude=rc,analytics --coverage --runInBand --verbose

###############################################################
FROM build-base as acx-ui-base-test
ENV NODE_OPTIONS=--max-old-space-size=8192

FROM acx-ui-base-test as acx-ui-lint
RUN node ./node_modules/.bin/nx run-many --target=lint --all --verbose
RUN touch lint-done

FROM acx-ui-base-test as acx-ui-tslint
COPY tools/docker/tscValidator.sh ./tools/docker/tscValidator.sh
RUN chmod +x tools/docker/tscValidator.sh
RUN tools/docker/tscValidator.sh
RUN touch tslint-done

FROM acx-ui-base-test as acx-ui-rc-test
# Run lint first so it can run parallel with build to leave test with more resources
# FROM acx-ui-lint as acx-ui-rc-test
RUN node ./node_modules/.bin/nx run rc:test --coverage --maxWorkers=50%
RUN node ./node_modules/.bin/nx run analytics:test --coverage --maxWorkers=50%
RUN node ./node_modules/.bin/nx run-many --target=test --all --exclude=rc,analytics --coverage --runInBand --verbose

FROM build-base as acx-ui-sonar-run
COPY --from=acx-ui-rc-test /app/coverage/* /app/coverage
# Potentially split tests into sub stages
#COPY --from=acx-ui-analytics-test /app/coverage/* /app/coverage
#COPY --from=acx-ui-test-manay /app/coverage/* /app/coverage
RUN touch tests-done

###############################################################

FROM node:14.21.1-alpine as build-locales

WORKDIR /app

# TODO
# copy only necessary folders to extract & generate local files
COPY --from=build-base /app /app
COPY tools/docker/locales ./tools/docker/locales
RUN chmod +x tools/docker/locales/generate.sh
RUN tools/docker/locales/generate.sh

###############################################################

FROM build-base as build
COPY --from=build-locales /app/apps/main/src/locales ./apps/main/src/locales
RUN node ./node_modules/.bin/nx run-many --target=build --all

###############################################################

FROM nginx:1.21.6-alpine as acx-ui-server

WORKDIR /usr/share/nginx/html

# Remove default nginx static assets
RUN rm -rf ./*

# Force dependency with lint related stages
COPY --from=acx-ui-lint   /app/lint-done   lint-done
COPY --from=acx-ui-tslint /app/tslint-done tslint-done

COPY tools/docker/nginx/conf.d/* /etc/nginx/conf.d/
COPY tools/docker/nginx/nginx.conf \
  tools/docker/nginx/start-nginx.sh \
  tools/docker/nginx/env.json.template \
  /etc/nginx/

COPY --from=build /app/dist/apps ./
RUN \
  # Move all other apps into main
  ls | grep -v main | xargs mv -t main && \
  # Create structure to match deployment need
  mkdir -p api/ui-beta && \
  # Move all files into it
  mv -v main/* api/ui-beta/. && \
  # Remove the main folder
  rm -rf main

FROM acx-ui-server as acx-ui-target

# Force dependency with tests related stages
COPY --from=acx-ui-sonar-run /app/tests-done tests-done

EXPOSE 8080

CMD ["/bin/sh", "/etc/nginx/start-nginx.sh"]
